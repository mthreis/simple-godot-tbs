[gd_scene load_steps=9 format=1]

[ext_resource path="res://assets/materials/gradient.tres" type="Shader" id=1]
[ext_resource path="res://px.png" type="Texture" id=2]
[ext_resource path="res://assets/tilesets/arena.tres" type="TileSet" id=3]
[ext_resource path="res://assets/tilesets/grasslands.tres" type="TileSet" id=4]
[ext_resource path="res://assets/prefabs/cyborg.tscn" type="PackedScene" id=5]
[ext_resource path="res://Sprite-0004.png" type="Texture" id=6]

[sub_resource type="GDScript" id=2]

script/source = "extends Node

var width
var height

var mstar

#this is used to keep track of where units are
var units = []

#this checks where there's an actual place and where there isn't
#var terrain = []

#this is used to keep track of tiles heights
var heightmap = []

func _ready():
	
	#get arena size to determine the size of the astar map
	var arenaSize = get_node(\"arena\").get_used_rect().size
	width  = arenaSize.x - 1
	height = arenaSize.y - 1
	
	print(\"Arena size: \", width, \"x\", height)
	
	#terrain.resize(width * height)
	heightmap.resize(width * height)
	units.resize(width * height)
	
	mstar = preload(\"res://Data/Scripts/MStar.gd\").new(50, 50)
	
	for x in range(0, width - 1):
		for y in range(0, height - 1):
			var p = Vector2(x, y)
			var id = flv(p)
			
			units[id] = null
			
			if get_cellv(p) >= 0:
				var h = get_tileset().tile_get_occluder_offset(get_cellv(p)).y
				heightmap[id] = h
			else:
				forbid_at(x, y)

func set_unit_at(pos, unit):
	units[flv(pos)] = unit

func forbid_at(x, y):
	mstar.forbid(x, y)

func free_at(x, y):
	mstar.freec(x, y)

#this returns an 1D index of the 2D position
func flv(vec):
	return vec.x + vec.y * mstar.width"

[sub_resource type="CanvasItemMaterial" id=1]

shader/shader = ExtResource( 1 )
shader/shading_mode = 0
shader_param/top = Color( 0.248909, 0.204849, 0.292969, 1 )
shader_param/bottom = Color( 0.0282059, 0.026123, 0.03125, 1 )

[node name="Scene" type="Node"]

script/script = SubResource( 2 )

[node name="canvas" type="CanvasLayer" parent="."]

editor/display_folded = true
layer = -1
offset = Vector2( 0, 0 )
rotation = 0.0
scale = Vector2( 1, 1 )

[node name="background" type="TextureFrame" parent="canvas"]

material/material = SubResource( 1 )
anchor/right = 1
anchor/bottom = 1
focus/ignore_mouse = true
focus/stop_mouse = true
size_flags/horizontal = 2
size_flags/vertical = 2
margin/left = 0.0
margin/top = 0.0
margin/right = 0.0
margin/bottom = 0.0
texture = ExtResource( 2 )
expand = true
stretch_mode = 0

[node name="arena" type="TileMap" parent="."]

mode = 1
tile_set = ExtResource( 3 )
cell/size = Vector2( 32, 16 )
cell/quadrant_size = 16
cell/custom_transform = Matrix32( 1, 0, 0, 1, 0, 0 )
cell/half_offset = 2
cell/tile_origin = 0
cell/y_sort = false
collision/use_kinematic = false
collision/friction = 1.0
collision/bounce = 0.0
collision/layers = 1
collision/mask = 1
occluder/light_mask = 1
tile_data = IntArray( -1, 0, -65536, 0, -65535, 0, -65534, 2, -65533, 3, -65532, 0, -65531, 0, 65535, 0, 131071, 0, 196607, 0, 262143, 0, 327679, 0 )

[node name="terrain" type="TileMap" parent="."]

editor/display_folded = true
mode = 1
tile_set = ExtResource( 4 )
cell/size = Vector2( 32, 16 )
cell/quadrant_size = 16
cell/custom_transform = Matrix32( 1, 0, 0, 1, 0, 0 )
cell/half_offset = 2
cell/tile_origin = 0
cell/y_sort = false
collision/use_kinematic = false
collision/friction = 1.0
collision/bounce = 0.0
collision/layers = 1
collision/mask = 1
occluder/light_mask = 1
tile_data = IntArray( 0, 3, 1, 1, 3, 3, 4, 4, 5, 5, 65536, 3, 65539, 2, 65540, 0, 65541, 0, 131072, 1, 131074, 1, 131075, 1, 131076, 0, 131077, 0, 196608, 0, 196609, 9, 196610, 0, 196611, 0, 196612, 0, 196613, 0, 262144, 1 )

[node name="cyborg" parent="terrain" instance=ExtResource( 5 )]

transform/pos = Vector2( 16, 3 )

[node name="Sprite" type="Sprite" parent="terrain"]

transform/pos = Vector2( 1, -24 )
texture = ExtResource( 6 )

[node name="Sprite1" type="Sprite" parent="terrain"]

transform/pos = Vector2( -34, 4 )
texture = ExtResource( 6 )

[node name="Sprite4" type="Sprite" parent="terrain"]

transform/pos = Vector2( -67, 21 )
texture = ExtResource( 6 )

[node name="Sprite2" type="Sprite" parent="terrain"]

transform/pos = Vector2( 48, 33 )
texture = ExtResource( 6 )

[node name="Sprite3" type="Sprite" parent="terrain"]

transform/pos = Vector2( 17, 50 )
texture = ExtResource( 6 )

[node name="camera" type="Camera2D" parent="."]

transform/pos = Vector2( 4, 1 )
anchor_mode = 1
rotating = false
current = true
zoom = Vector2( 0.3333, 0.3333 )
limit/left = -10000000
limit/top = -10000000
limit/right = 10000000
limit/bottom = 10000000
drag_margin/h_enabled = true
drag_margin/v_enabled = true
smoothing/enable = false
smoothing/speed = 5.0
drag_margin/left = 0.2
drag_margin/top = 0.2
drag_margin/right = 0.2
drag_margin/bottom = 0.2


